# 第五章

- 概述
- 與 Github 連線
- 總結

---

在我們開工之前，先取得`4-end`的程式碼。[4-end](https://github.com/menon-pheno/fullstack-bookstore/tree/master/book/4-end)資料夾位於[fullstack-bookstore repo](https://github.com/menon-pheno/fullstack-bookstore)`book`的目錄內。

- 如果你還沒有將 fullstack-bookstore 給 clone 下來的話，用`git clone https://github.com/menon-pheno/fullstack-bookstore`這個指令將 repo 複製到你的電腦上
- 注意：如果你想要用自己的 GitHub 帳號自己管理程式的話，你應該將我們的 repo fork 出來並且執行`git clone https://github.com/<你的 github 名稱>/fullstack-bookstore.git`。這樣你就可以將你的改動直接 push 到你的`fullstack-bookstore` repo
- 在`4-end`的資料夾內執行`yarn`來安裝所有的套件

我們在第四章會新增以下的套件：

- `"Octokit"`

-

看一下第五章的 [package.json](https://github.com/menon-pheno/fullstack-bookstore/blob/master/book/5-end/package.json)。

請確定使用我們指定的套件跟版本，並忽略任何升級的警告。我們會定期更新套件且測試相容性。我們無法確保新的套件版本與目前的程式碼都相容，套件升級時有的時候會導致一些預料之外的問題。

記得將你第四章更新的 `.env.local` 檔案放到專案的根目錄下。

我們鼓勵且歡迎你在閱讀本章的時候，可以在我們的 GitHub repo: [https://github.com/menon-pheno/fullstack-bookstore/issues/new](https://github.com/menon-pheno/fullstack-bookstore)回報任何 bug、錯字或是任何解釋不清楚的地方。

---

## 概述

我們在本章中將會將我們的網站與 Github 給對接起來，我們的目標是要將 Github 內所存放的書本資料透過我們 Next.js 的伺服器，將資訊存放到我們的 MongoDB 內。

我們另外也會有一些新的 UI 設計，像是一個 `連接 Github` 以及 `同步 Github` 的按鈕。這個實作完後，我們的管理者角色的使用者就可以建立一個新的書本，並且從 Github repository 將書本的資料給抓取下來。

---

## 與 Github 連線

我們的第一步，是先讓我們的網站能與 Github 做連接。莫忘初衷，我們的設計是將一個 Github 的 repository 當作一本書的全部內容。所以當我們能夠將網站與 Github 連接的時候，就代表我們可以拿到書本的內容了。

我們會透過 Github 官方認證的 [octokit](https://github.com/octokit/octokit.js) 來進行與 Github 連線的功能：

```
yarn add octokit
```

看一下 [Github 建議的 API 認證方式](https://docs.github.com/en/enterprise-server@3.4/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token)，Github 建議使用 API 來存取 Github 時使用 personal access token 而不是使用帳號密碼的方式。

申請 Github Personal Access Token 的方式在上面的網址描述的很清楚，我們在本書中不重複了。

---

`yarn add octokit`

Add Personal Access token
[github](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token)

`pages/api/git-test.js`

Add Environment Variable for Vercel

`pages/admin/index.js`
`pages/admin/add-book.js`

Admin user not connected to Github will see Connect Github
`models/User.js` add following four fields:

```JSON
isGithubConnected: {
    type: Boolean,
    default: false,
  },
  githubAccessToken: {
    type: String,
  },
  githubId: {
    type: String,
    unique: true,
  },
  githubUsername: {
    type: String,
    unique: true,
  },
```

```JavaScript
class UserClass {
  static publicFields() {
    return ["id", "name", "email", "image", "isAdmin", "isGithubConnected"];
  }
}
UserSchema.loadClass(UserClass);
```
