# 第三章

- 概述
- `next-auth`

  - GCP（Google Cloud Platform）設定
  - `[...nextauth].js`

- withAuth（認證用）HOC
  - getInitialProps 函式
  - withAuth HOC 的參數
  - 測試 withAuth
  - 登入頁面（Login）與 NProgress
  - 非同步（asynchronous）執行及 callback
    - Promise.then
    - async/await
  - 整合 Google OAuth API
    - setupGoogle 函式、verify 函式、passport 及 strategy
    - /auth/google、/oauth2callback 及 /logout Express 路由
    - User.publicFields 及 User.signInOrSignUp 函式
    - generateSlug 函式
    - GCP（Google Cloud Platform）設定與測試

---

在我們開工之前，先取得`2-end`的程式碼。[2-end](https://github.com/menon-pheno/fullstack-bookstore/tree/master/book/2-end)資料夾位於[fullstack-bookstore repo](https://github.com/menon-pheno/fullstack-bookstore)`book`的目錄內。

- 如果你還沒有將 fullstack-bookstore 給 clone 下來的話，用`git clone https://github.com/menon-pheno/fullstack-bookstore`這個指令將 repo 複製到你的電腦上
- 注意：如果你想要用自己的 GitHub 帳號自己管理程式的話，你應該將我們的 repo fork 出來並且執行`git clone https://github.com/<你的 github 名稱>/fullstack-bookstore.git`。這樣你就可以將你的改動直接 push 到你的`fullstack-bookstore` repo
- 在`2-end`的資料夾內執行`yarn`來安裝所有的套件

我們在第三章有新增以下幾個套件：

- `"next-auth"`

看一下第三章的 [package.json](https://github.com/menon-pheno/fullstack-bookstore/blob/master/book/3-begin/package.json)。

請確定使用我們指定的套件跟版本，並忽略任何升級的警告。我們會定期更新套件且測試相容性。我們無法確保新的套件版本與目前的程式碼都相容，套件升級時有的時候會導致一些預料之外的問題。

記得將你第二章建立的 `.env.local` 檔案放到專案的根目錄下。到本章的尾聲時，你會另外加上：

- `GOOGLE_ID`
- `GOOGLE_SECRET`
- `NEXTAUTH_URL`
- `NEXTAUTH_SECRET`

到你的 `.env.local` 檔內。

我們鼓勵且歡迎你在閱讀本章的時候，可以在我們的 GitHub repo: [https://github.com/menon-pheno/fullstack-bookstore/issues/new](https://github.com/menon-pheno/fullstack-bookstore)回報任何 bug、錯字或是任何解釋不清楚的地方。

---

## 概述

我們到目前為止，有了一個可以和雲端 MongoDB Atlas 連接的網站，並且介紹了怎麼透過適合的 Material-UI 元件，來設計我們的頁面。這章最主要的重點在於，讓我們的網站可以進行使用者認證的功能。這章我們就要來讓網站支援 Google 登入，並且將資訊存入我們連接的 MongoDB Atlas 內。

---

## `next-auth`

[Next.js 認證的官方建議](https://nextjs.org/docs/authentication)可以看到它建議的完整認證支援的套件是 `next-auth`。我們從善如流，安裝 `next-auth` 來使用：

```
yarn add next-auth
```

然後看一下 [next-auth 的官方說明](https://next-auth.js.org/getting-started/example#existing-project)

讓我們逐步說明每個步驟的意涵以及實作的內容。

### GCP（Google Cloud Platform）設定

由於我們這邊將會實作的是讓使用者可以透過他們的 Google 帳號來登入我們的網站，我們必須將我們的專案在 GCP 上註冊，以取得 GCP 核發給我們專案專屬的 `Client ID` 以及 `Client secret`。請參閱[GCP 註冊專案的官方文件](https://developers.google.com/identity/sign-in/web/devconsole-project)。由於官方文件相當清楚，我們不重複，就照著做，取得 OAuth 認證資料，要注意的有以下兩件事：

- `Authorized JavaScript origins` 填 `http://localhost:3000`
- `Authorized redirect URIs` 填 `http://localhost:3000/api/auth/callback/google`

另外一提，當我們要部署上 Vercel 的時候，要再各自新增雲端網址的 URI。

將取得的 `Client ID` 及 `Client Secret` 放到我們的 `.env.local` 檔內：

```
GOOGLE_ID="{你的 Google Client ID}"
GOOGLE_SECRET="{你的 Google Client Secret}"
```

### `[...nextauth].js`

我們先來快速在我們的專案上實作一個有實際達到使用 Google 登入功能的階段性，然後再來解釋過程並且逐步改戰。

1. 新增 `pages/api/auth/[...nextauth].js` 這個檔案（同時新增 `pages/api` 以及 `pages/api/auth` 這兩個資料夾），內容如下：

   ```JavaScript
   import NextAuth from "next-auth";
   import GoogleProvider from "next-auth/providers/google";

   export default NextAuth({
    providers: [
      GoogleProvider({
        clientId: process.env.GOOGLE_ID,
        clientSecret: process.env.GOOGLE_SECRET,
      }),
    ],
    secret: process.env.NEXAUTH_SECRET,
   });
   ```

   - 上面的 `secret` 屬性，你可以使用終端機執行 `openssl rand -base64 32` 來取得一個安全性夠高的字串，然後將這個值加入到 `.env.local` 內
   - 另外在 `.env.local` 上加上 `NEXAUTH_URL="http://localhost:3000"` 這個環境變數

2. `pages/_app.js` 修改成以下（我把更動的部分上面加了註解）：

   ```JavaScript
   import PropTypes from "prop-types";
   import { CacheProvider } from "@emotion/react";
   import { CssBaseline } from "@mui/material";
   import { ThemeProvider } from "@mui/material/styles";
   import Head from "next/head";
   // 使用 `next-auth/react` 來紀錄使用者的 session
   import { SessionProvider } from "next-auth/react";

   import createEmotionCache from "../styling/createEmotionCache";
   import basicTheme from "../styling/themes/basicTheme";

   const clientSideEmotionCache = createEmotionCache();

   export default function MyApp(props) {
     const {
       Component,
       // pageProps 多補上一個 session 屬性
       pageProps: { session, ...pageProps },
       emotionCache = clientSideEmotionCache,
     } = props;
     return (
       // 將我們原本 _app.js 所回傳的元件，用 <SessionProvider> 包覆起來
       <SessionProvider session={session}>
         <CacheProvider value={emotionCache}>
           <Head>
             <meta name="viewport" content="initial-scale=1, width=device-width" />
           </Head>
           <ThemeProvider theme={basicTheme}>
             <CssBaseline />
             <Component {...pageProps} />
           </ThemeProvider>
         </CacheProvider>
       </SessionProvider>
     );
   }

   MyApp.propTypes = {
     Component: PropTypes.elementType.isRequired,
     emotionCache: PropTypes.object,
     pageProps: PropTypes.object.isRequired,
   };

   ```

3. index.js

4. Vercel
   NEXTAUTH_URL=https://fullstack-bookstore.vercel.app/
   CLIENT_ID/SECRET
   NEXTAUTH_SECRET (openssl rand -base64 32)

5. Add GCP URL
